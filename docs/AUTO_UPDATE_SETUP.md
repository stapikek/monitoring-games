# Настройка автоматического обновления серверов

## Обзор

Система автоматически обновляет информацию о серверах каждые 5 минут на двух уровнях:
1. **Фронтенд** - обновление в браузере пользователя
2. **Бэкенд** - обновление в базе данных через cron

---

## Фронтенд (JavaScript)

### Где настроено:
`/assets/js/common.js`

### Что делает:
- Обновляет информацию о серверах на главной странице каждые 5 минут
- Запрашивает данные через `/api/server_info.php`
- Обновляет: количество игроков, карту

### Код:
```javascript
// Обновление каждые 5 минут (300000 миллисекунд)
setInterval(function() {
    updateAllServers();
}, 300000);
```

### Изменение интервала:
Если нужно изменить частоту, измените значение в миллисекундах:
- 1 минута = 60000
- 3 минуты = 180000
- 5 минут = 300000
- 10 минут = 600000

---

## Бэкенд (Cron)

### Где настроено:
`/api/update_all_servers.php` - запускается через cron

### Что делает:
1. Получает все активные серверы из БД
2. Для каждого сервера запрашивает актуальную информацию через Steam Query
3. Обновляет в БД: `current_players`, `max_players`, `last_updated`
4. Логирует результаты

### Важно:
- **Карта НЕ сохраняется в БД** - она всегда берётся напрямую через API
- Обновляются только счётчики игроков для быстрого отображения

---

## Установка Cron задачи

### Автоматическая установка:

```bash
cd /path/to/project
php setup_cron.php --install
```

Скрипт автоматически:
- Определит путь к проекту
- Создаст cron задачу
- Настроит логирование
- Проверит существующие задачи

### Ручная установка:

```bash
# Открыть редактор crontab
crontab -e

# Добавить строку (измените путь на свой):
*/5 * * * * /usr/bin/php /path/to/project/api/update_all_servers.php >> /path/to/project/logs/server_update.log 2>&1
```

### Расшифровка cron формата:
```
*/5 * * * *
│   │ │ │ │
│   │ │ │ └─── День недели (0-7, 0 и 7 = воскресенье)
│   │ │ └───── Месяц (1-12)
│   │ └─────── День месяца (1-31)
│   └───────── Час (0-23)
└─────────── Минута (0-59) - */5 означает "каждые 5 минут"
```

---

## Мониторинг

### Просмотр логов:

```bash
# Последние 50 строк
tail -n 50 /path/to/project/logs/server_update.log

# Отслеживание в реальном времени
tail -f /path/to/project/logs/server_update.log

# Поиск ошибок
grep "Error" /path/to/project/logs/server_update.log
```

### Пример успешного лога:
```
Starting server update...
Found 3 active servers
Updating server 3 (95.213.255.68:27615)...
  ✓ Updated: Players 0/32, Map: sandstone_new
Updating server 4 (185.137.235.124:27015)...
  ✓ Updated: Players 0/40, Map: de_mirage
Updating server 5 (95.213.255.76:27315)...
  ✓ Updated: Players 0/26, Map: hns_backyard_v1
Update completed. Updated: 3, Failed: 0
```

### Проверка работы cron:

```bash
# Показать все задачи cron
crontab -l

# Показать только задачи обновления серверов
crontab -l | grep update_all_servers

# Проверить, запускается ли cron (системный лог)
grep CRON /var/log/syslog | tail -20
```

---

## Настройка интервала

### Изменить на другой интервал:

**Каждую минуту:**
```bash
* * * * * /usr/bin/php /path/to/update_all_servers.php
```

**Каждые 3 минуты:**
```bash
*/3 * * * * /usr/bin/php /path/to/update_all_servers.php
```

**Каждые 10 минут:**
```bash
*/10 * * * * /usr/bin/php /path/to/update_all_servers.php
```

**Каждый час:**
```bash
0 * * * * /usr/bin/php /path/to/update_all_servers.php
```

---

## Устранение проблем

### Cron не запускается:

1. **Проверить синтаксис cron:**
```bash
crontab -l | grep update_all_servers
```

2. **Проверить путь к PHP:**
```bash
which php
# Используйте полученный путь в crontab
```

3. **Проверить права доступа:**
```bash
chmod +x /path/to/project/api/update_all_servers.php
chmod 755 /path/to/project/logs
```

4. **Запустить скрипт вручную:**
```bash
php /path/to/project/api/update_all_servers.php
```

### Логи не создаются:

```bash
# Создать директорию логов
mkdir -p /path/to/project/logs
chmod 755 /path/to/project/logs

# Проверить права пользователя cron
ps aux | grep cron
```

### Серверы не обновляются:

1. **Проверить подключение к серверам:**
```bash
# Проверить UDP порт
nc -u -v 95.213.255.68 27615
```

2. **Проверить firewall:**
```bash
# Разрешить исходящие UDP соединения
sudo ufw allow out to any port 27015:27615 proto udp
```

3. **Увеличить timeout:**
В `config/server_query.php` измените:
```php
private $timeout = 5; // было 3
```

---

## Производительность

### Рекомендации:

- **5 минут** - оптимально для большинства случаев
- **1-3 минуты** - если нужны максимально актуальные данные (больше нагрузка)
- **10-15 минут** - если серверов много (> 50) или они часто недоступны

### Оптимизация:

1. **Параллельные запросы** (для большого количества серверов):
Можно модифицировать скрипт для использования параллельных запросов

2. **Кеширование:**
База данных уже служит кешем - фронтенд может показывать последние известные данные

3. **Приоритезация:**
Обновлять VIP серверы чаще, чем обычные

---

## Безопасность

### Рекомендации:

1. **Логи:** Регулярно ротировать логи (logrotate)
2. **Права:** Скрипт должен запускаться от пользователя www-data или аналогичного
3. **Мониторинг:** Настроить алерты при большом количестве ошибок

### Logrotate конфигурация:

Создать `/etc/logrotate.d/cs2-monitoring`:
```
/path/to/project/logs/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
}
```

---

## Диагностика

### Команды для диагностики:

```bash
# 1. Проверить статус cron сервиса
sudo systemctl status cron

# 2. Перезапустить cron
sudo systemctl restart cron

# 3. Проверить последние запуски
grep update_all_servers /var/log/syslog | tail -10

# 4. Тестовый запуск с выводом
php -d display_errors=On /path/to/project/api/update_all_servers.php

# 5. Проверить занятость серверов
netstat -an | grep 27015
```

---

## Чек-лист установки

- [ ] Cron задача добавлена (`crontab -l`)
- [ ] Директория логов существует и доступна для записи
- [ ] Скрипт запускается вручную без ошибок
- [ ] Логи создаются и заполняются
- [ ] Данные в БД обновляются
- [ ] Фронтенд показывает актуальные данные
- [ ] Настроен logrotate (опционально)

---

## Связанные файлы

- `/api/update_all_servers.php` - Скрипт обновления
- `/config/server_query.php` - Класс запросов к серверам
- `/assets/js/common.js` - Фронтенд обновление
- `/setup_cron_5min.sh` - Автоматическая установка cron
- `/logs/cron_update.log` - Лог файл

---